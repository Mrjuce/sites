<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∞–ª–æ–Ω ‚Äî –û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å –¥–ª—è –º–∞–π—Å—Ç—Ä–∞</title>
  <style>
    :root{
      --bg:#0b0d10;--card:#131720;--muted:#222735;--ink:#ebf0ff;--ink-dim:#b7c1da;
      --brand:#7c9cff;--ok:#58d38c;--warn:#ffd166;--bad:#ff6b6b;--shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:linear-gradient(160deg,#0b0d10,#0f1320 60%); color:var(--ink); -webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; gap:14px; align-items:center; justify-content:space-between; margin-bottom:16px}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#9be2ff); box-shadow:var(--shadow)}
    h1{font-size:20px;margin:0; font-weight:700}
    .muted{color:var(--ink-dim); font-size:13px}
    .card{background:var(--card); border:1px solid #20263a; border-radius:var(--radius); box-shadow:var(--shadow)}
    /* Auth */
    #loginView{max-width:520px; margin:8vh auto; padding:22px}
    .field{display:flex; flex-direction:column; gap:8px; margin:12px 0}
    label{font-size:13px; color:var(--ink-dim)}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{width:100%; background:#0f1320; border:1px solid #2a3350; color:var(--ink); padding:10px 12px; border-radius:10px; outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--brand)}
    .row{display:flex; gap:10px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid #2a3350; background:#151a28; color:var(--ink); cursor:pointer; transition:.12s}
    .btn:hover{transform:translateY(-2px); border-color:#3a4570}
    .btn.primary{background:linear-gradient(135deg,var(--brand),#97aaff); color:#0b0d10}
    .btn.ghost{background:transparent}
    /* App */
    #appView{display:none}
    .grid{display:grid; grid-template-columns: 280px 1fr; gap:16px}
    .section{padding:16px}
    .section h2{margin:0 0 12px; font-size:16px}
    .badge{display:inline-flex; padding:6px 10px; font-size:12px; background:#11162a; border:1px solid #263155; border-radius:999px; color:var(--ink-dim)}
    /* Sidebar */
    .side .master{display:flex; align-items:center; gap:10px}
    .avatar{width:46px;height:46px;border-radius:12px;background:#1b2238; display:grid; place-items:center; font-weight:700}
    .side .actions{display:flex; gap:8px; margin-top:10px}
    .side .field{margin:10px 0}
    /* Schedule */
    .schedule{padding:8px}
    .slotGrid{display:grid; gap:8px}
    .slot{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px dashed #2a3350; border-radius:10px; background:#0f1320; cursor:pointer}
    .slot:hover{border-style:solid}
    .slot .t{font-weight:600}
    .slot.booked{background:#15203a; border-color:#364477; cursor:default}
    .slot.booked .t{color:#cfe1ff}
    .slot .who{color:var(--ink-dim); font-size:13px}
    .legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 0}
    .dot{width:10px;height:10px;border-radius:50%; background:#2a3350; display:inline-block}
    .dot.free{background:#2a6f50}
    .dot.booked{background:#3b4d82}
    /* Modal */
    dialog{border:none; border-radius:12px; background:var(--card); color:var(--ink); max-width:520px; width:100%; box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    dialog form{padding:12px 16px}
    dialog h3{margin:8px 0 12px; font-size:18px}
    .danger{color:var(--bad)}
    /* Table of day */
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:10px 12px; border-bottom:1px solid #222a44}
    th{position:sticky; top:0; background:#121728; text-align:left}
    tr:hover td{background:#0f1424}
    .pill{padding:4px 8px; border:1px solid #2a3350; border-radius:999px; font-size:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    /* Admin small */
    #adminPanel{display:none}
    .small{font-size:13px;color:var(--ink-dim)}
    .controls {display:flex; gap:8px; flex-wrap:wrap}
    .muted-compact{color:#98a3c7;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>–û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å –¥–ª—è –º–∞–π—Å—Ç—Ä–∞</h1>
          <div class="muted">–°–∞–ª–æ–Ω –∫—Ä–∞—Å–∏ ‚Ä¢ –ª–æ–∫–∞–ª—å–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞)</div>
        </div>
      </div>
      <div id="brandUser" class="muted small"></div>
    </header>

    <!-- Login -->
    <section id="loginView" class="card">
      <div class="section">
        <h2>–í—Ö—ñ–¥</h2>
        <div class="muted-compact">–î–µ–º–æ: <b>master1</b>/<b>letmein</b>, <b>nailpro</b>/<b>letmein</b>, <b>admin</b>/<b>admin</b></div>
        <div class="field">
          <label for="login">–õ–æ–≥—ñ–Ω</label>
          <input id="login" autocomplete="username" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: master1">
        </div>
        <div class="field">
          <label for="password">–ü–∞—Ä–æ–ª—å</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="–ø–∞—Ä–æ–ª—å">
        </div>
        <div class="row">
          <button id="btnLogin" class="btn primary">–£–≤—ñ–π—Ç–∏</button>
          <button id="btnDemoFill" class="btn ghost" type="button">–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –¥–µ–º–æ</button>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="appView" style="display:none">
      <div class="grid">
        <!-- Sidebar -->
        <aside class="card side">
          <div class="section">
            <div class="master">
              <div class="avatar" id="avatar">üíÖ</div>
              <div>
                <div id="userName" style="font-weight:700">–ú–∞–π—Å—Ç–µ—Ä</div>
                <div class="muted" id="userRole">–†–æ–ª—å</div>
              </div>
            </div>
            <div class="actions" style="margin-top:12px">
              <button id="btnLogout" class="btn">–í–∏–π—Ç–∏</button>
              <button id="btnToday" class="btn">–°—å–æ–≥–æ–¥–Ω—ñ</button>
            </div>

            <div class="field">
              <label for="datePicker">–î–∞—Ç–∞</label>
              <input id="datePicker" type="date">
            </div>
            <div class="field">
              <label for="workHours">–ì–æ–¥–∏–Ω–∏ —Ä–æ–±–æ—Ç–∏ (–ø–æ—á–∞—Ç–æ–∫-–∫—ñ–Ω–µ—Ü—å)</label>
              <input id="workHours" value="10:00-19:00" placeholder="10:00-19:00">
            </div>
            <div class="field">
              <label for="slotLen">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–ª–æ—Ç—É (—Ö–≤)</label>
              <select id="slotLen">
                <option>30</option>
                <option>45</option>
                <option selected>60</option>
              </select>
            </div>
            <div style="margin-top:10px">
              <span class="badge">–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è: LocalStorage</span>
            </div>
          </div>
        </aside>

        <!-- Schedule -->
        <main class="card">
          <div class="section">
            <h2 id="dayTitle">–†–æ–∑–∫–ª–∞–¥</h2>
            <div class="legend">
              <span class="dot free"></span><span class="muted">–≤—ñ–ª—å–Ω–æ</span>
              <span class="dot booked"></span><span class="muted">–∑–∞–π–Ω—è—Ç–æ</span>
            </div>
          </div>

          <div class="schedule section">
            <div id="slotGrid" class="slotGrid"></div>
          </div>

          <div class="section">
            <h2>–ó–∞–ø–∏—Å–∏ –∑–∞ –¥–µ–Ω—å</h2>
            <div class="muted-compact">–ö–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ —Å–ª–æ—Ç—É, —â–æ–± –¥–æ–¥–∞—Ç–∏/—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å</div>
            <div style="margin-top:12px">
              <table>
                <thead>
                  <tr>
                    <th>–ß–∞—Å</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞</th><th>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th></th>
                  </tr>
                </thead>
                <tbody id="dayTable"></tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </section>

    <!-- Admin -->
    <section id="adminView" class="card" style="display:none">
      <div class="section">
        <h2>–ú–µ–Ω—é –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
        <div class="muted-compact">–¢—É—Ç –∞–¥–º—ñ–Ω –º–æ–∂–µ –∫–µ—Ä—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ (–º–∞–π—Å—Ç—Ä–∞–º–∏)</div>

        <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
          <div style="flex:1; min-width:260px;">
            <div class="field"><label>–ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Äî –ª–æ–≥—ñ–Ω</label><input id="newLogin" placeholder="–ª–æ–≥—ñ–Ω"></div>
            <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input id="newPass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
            <div class="field"><label>–Ü–º'—è</label><input id="newName" placeholder="—ñ–º'—è"></div>
            <div class="field"><label>–†–æ–ª—å</label><input id="newRole" placeholder="—Ä–æ–ª—å (–Ω–∞–ø—Ä. Nails)"></div>
            <div class="row"><button id="btnAddUser" class="btn primary">–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button></div>
          </div>

          <div style="flex:2; min-width:320px;">
            <h3>–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
            <table>
              <thead><tr><th>–õ–æ–≥—ñ–Ω</th><th>–Ü–º'—è</th><th>–†–æ–ª—å</th><th></th></tr></thead>
              <tbody id="userTable"></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:16px">
          <button id="btnDumpAll" class="btn">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏ localStorage (JSON)</button>
        </div>
        <pre id="dump" style="margin-top:8px; display:none; background:#0f1320; padding:10px; border-radius:8px; max-height:220px; overflow:auto;"></pre>
      </div>
    </section>
  </div>

  <!-- Booking Modal -->
  <dialog id="bookingModal">
    <form method="dialog" id="bookingForm">
      <h3 id="modalTitle">–ù–æ–≤–∏–π –∑–∞–ø–∏—Å</h3>
      <div style="display:flex; gap:8px;">
        <div style="flex:1" class="field"><label>–ß–∞—Å –ø–æ—á–∞—Ç–∫—É</label><input id="fStart" readonly></div>
        <div style="width:120px" class="field"><label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)</label>
          <select id="fDur"><option>30</option><option>45</option><option selected>60</option><option>90</option><option>120</option></select>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <div style="flex:1" class="field"><label>–ö–ª—ñ—î–Ω—Ç</label><input id="fClient" placeholder="–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞" required></div>
        <div style="flex:1" class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="fPhone" placeholder="+380..."></div>
      </div>
      <div style="display:flex; gap:8px;">
        <div style="flex:1" class="field"><label>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞</label>
          <select id="fProc"><option>–ú–∞–Ω—ñ–∫—é—Ä</option><option>–ü–µ–¥–∏–∫—é—Ä</option><option>–ë—Ä–æ–≤–∏/–õ–∞–º—ñ–Ω—É–≤–∞–Ω–Ω—è</option><option>–°—Ç—Ä–∏–∂–∫–∞</option><option>–§–∞—Ä–±—É–≤–∞–Ω–Ω—è</option><option>–ú–∞–∫—ñ—è–∂</option><option>–î–µ–ø—ñ–ª—è—Ü—ñ—è</option><option>–Ü–Ω—à–µ</option></select>
        </div>
        <div style="flex:1" class="field"><label>–ù–æ—Ç–∞—Ç–∫–∞</label><input id="fNote" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä"></div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
        <div style="display:flex; gap:8px;">
          <button class="btn" id="btnCancel" type="button">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn primary" id="btnSave" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
        <button class="btn danger" id="btnDelete" type="button" style="display:none">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>
    </form>
  </dialog>

  <!-- User Edit Modal (Admin) -->
  <dialog id="userModal">
    <form method="dialog" id="userForm">
      <h3 id="userModalTitle">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h3>
      <div class="field"><label>–õ–æ–≥—ñ–Ω</label><input id="uLogin" readonly></div>
      <div class="field"><label>–ü–∞—Ä–æ–ª—å (–∑–∞–ª–∏—à–∏—Ç–∏ –ø—É—Å—Ç–∏–º —â–æ–± –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏)</label><input id="uPass" type="password"></div>
      <div class="field"><label>–Ü–º'—è</label><input id="uName"></div>
      <div class="field"><label>–†–æ–ª—å</label><input id="uRole"></div>

      <div style="display:flex; justify-content:space-between; margin-top:8px;">
        <div style="display:flex; gap:8px;">
          <button class="btn" id="uCancel" type="button">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn primary" id="uSave" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
        <button class="btn danger" id="uDelete" type="button">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>
    </form>
  </dialog>

  <script>
  ;(function(){
    /* ---------------------------
       Storage keys & helpers
       --------------------------- */
    const LS_USERS_KEY = 'salon:users'
    const DEFAULT_USERS = {
      master1:{password:'letmein', name:'–ê–ª—ñ–Ω–∞', role:'Nails'},
      nailpro:{password:'letmein', name:'–ú–∞—Ä–∏–Ω–∞', role:'Brows'},
      brows:{password:'letmein', name:'–û–ª—è', role:'Hair'},
      admin:{password:'admin', name:'–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä', role:'Admin'}
    }

    function loadUsers(){
      try{
        const raw = localStorage.getItem(LS_USERS_KEY)
        return raw ? JSON.parse(raw) : {...DEFAULT_USERS}
      }catch(e){ return {...DEFAULT_USERS} }
    }
    function saveUsers(obj){
      localStorage.setItem(LS_USERS_KEY, JSON.stringify(obj))
    }

    function keyForDay(userId, ymd){ return `salon:${userId}:${ymd}` }
    function ymdFromDate(d){ return d.toISOString().slice(0,10) }
    function loadDay(userId, ymd){
      try{
        const raw = localStorage.getItem(keyForDay(userId, ymd))
        return raw ? JSON.parse(raw) : {bookings:[]}
      }catch(e){ return {bookings:[]} }
    }
    function saveDay(userId, ymd, data){
      localStorage.setItem(keyForDay(userId, ymd), JSON.stringify(data))
    }

    /* ---------------------------
       DOM refs
       --------------------------- */
    const loginView = document.getElementById('loginView')
    const appView = document.getElementById('appView')
    const adminView = document.getElementById('adminView')
    const brandUser = document.getElementById('brandUser')
    const userNameEl = document.getElementById('userName')
    const userRoleEl = document.getElementById('userRole')
    const avatarEl = document.getElementById('avatar')

    const loginInput = document.getElementById('login')
    const passInput = document.getElementById('password')
    const btnLogin = document.getElementById('btnLogin')
    const btnDemoFill = document.getElementById('btnDemoFill')
    const btnLogout = document.getElementById('btnLogout')
    const btnToday = document.getElementById('btnToday')

    // schedule refs
    const datePicker = document.getElementById('datePicker')
    const workHours = document.getElementById('workHours')
    const slotLen = document.getElementById('slotLen')
    const slotGrid = document.getElementById('slotGrid')
    const dayTable = document.getElementById('dayTable')
    const dayTitle = document.getElementById('dayTitle')

    // booking modal refs
    const bookingModal = document.getElementById('bookingModal')
    const fStart = document.getElementById('fStart')
    const fDur = document.getElementById('fDur')
    const fClient = document.getElementById('fClient')
    const fPhone = document.getElementById('fPhone')
    const fProc = document.getElementById('fProc')
    const fNote = document.getElementById('fNote')
    const btnCancel = document.getElementById('btnCancel')
    const btnSave = document.getElementById('btnSave')
    const btnDelete = document.getElementById('btnDelete')

    // admin refs
    const newLogin = document.getElementById('newLogin')
    const newPass = document.getElementById('newPass')
    const newName = document.getElementById('newName')
    const newRole = document.getElementById('newRole')
    const btnAddUser = document.getElementById('btnAddUser')
    const userTable = document.getElementById('userTable')
    const btnDumpAll = document.getElementById('btnDumpAll')
    const dump = document.getElementById('dump')

    // user modal (admin)
    const userModal = document.getElementById('userModal')
    const uLogin = document.getElementById('uLogin')
    const uPass = document.getElementById('uPass')
    const uName = document.getElementById('uName')
    const uRole = document.getElementById('uRole')
    const uCancel = document.getElementById('uCancel')
    const uSave = document.getElementById('uSave')
    const uDelete = document.getElementById('uDelete')
    const userModalTitle = document.getElementById('userModalTitle')

    /* ---------------------------
       State
       --------------------------- */
    let USERS = loadUsers()
    let currentUser = null
    let editingBookingExisting = null

    /* ---------------------------
       Auth
       --------------------------- */
    btnDemoFill.addEventListener('click', ()=>{ loginInput.value='master1'; passInput.value='letmein' })
    btnLogin.addEventListener('click', ()=> {
      const l = loginInput.value.trim()
      const p = passInput.value
      const u = USERS[l]
      if(!u || u.password !== p){ alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å'); return }
      currentUser = {id: l, ...u}
      afterLogin()
    })

    btnLogout.addEventListener('click', ()=> {
      currentUser = null
      appView.style.display = 'none'
      adminView.style.display = 'none'
      loginView.style.display = 'block'
      brandUser.textContent = ''
    })

    function afterLogin(){
      loginView.style.display = 'none'
      brandUser.textContent = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${currentUser.name} (${currentUser.id})`
      if(currentUser.id === 'admin'){
        adminView.style.display = 'block'
        appView.style.display = 'none'
        renderUsers()
      } else {
        adminView.style.display = 'none'
        appView.style.display = 'block'
        userNameEl.textContent = currentUser.name
        userRoleEl.textContent = currentUser.role
        avatarEl.textContent = getEmojiForRole(currentUser.role)
        const today = new Date()
        datePicker.valueAsDate = today
        renderDay()
      }
    }

    btnToday.addEventListener('click', ()=> { datePicker.valueAsDate = new Date(); renderDay() })
    datePicker.addEventListener('change', renderDay)
    workHours.addEventListener('change', renderDay)
    slotLen.addEventListener('change', renderDay)

    function getEmojiForRole(role){
      if(!role) return 'üíÖ'
      role = role.toLowerCase()
      if(role.includes('brow')||role.includes('brows')) return '‚ú®'
      if(role.includes('hair')||role.includes('—Å—Ç—Ä–∏–∂')) return 'üíá'
      if(role.includes('nail')||role.includes('–º–∞–Ω—ñ–∫')) return 'üíÖ'
      return 'üé®'
    }

    /* ---------------------------
       Schedule rendering & logic
       --------------------------- */
    function parseHours(str){
      const m = str.match(/^(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})$/)
      if(!m) return [600, 1140]
      const s = (+m[1])*60 + (+m[2])
      const e = (+m[3])*60 + (+m[4])
      return [s,e]
    }
    function minToStr(min){
      const h = Math.floor(min/60).toString().padStart(2,'0')
      const m = (min%60).toString().padStart(2,'0')
      return `${h}:${m}`
    }
    function overlaps(aStart, aDur, bStart, bDur){
      const aEnd = aStart + aDur
      const bEnd = bStart + bDur
      return aStart < bEnd && bStart < aEnd
    }

    function renderDay(){
      if(!currentUser) return
      const d = datePicker.valueAsDate || new Date()
      const ymd = ymdFromDate(d)
      dayTitle.textContent = `–†–æ–∑–∫–ª–∞–¥ –Ω–∞ ${d.toLocaleDateString('uk-UA',{weekday:'long', day:'2-digit', month:'2-digit'})}`

      const [startMin,endMin] = parseHours(workHours.value.trim())
      const step = +slotLen.value
      const slots = []
      for(let t = startMin; t < endMin; t += step) slots.push({t, label: minToStr(t)})

      const data = loadDay(currentUser.id, ymd)
      slotGrid.innerHTML = ''
      dayTable.innerHTML = ''

      const byStart = new Map(data.bookings.map(b=>[b.start,b]))

      for(const s of slots){
        const b = byStart.get(s.t)
        const el = document.createElement('div')
        el.className = 'slot' + (b ? ' booked' : '')
        el.dataset.start = s.t
        el.innerHTML = `<div class="t">${s.label}</div>` + (b ? `<div class="who">${b.client} ‚Ä¢ ${b.proc} (${b.dur} —Ö–≤)</div>` : `<div class="who">–í—ñ–ª—å–Ω–æ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏</div>`)
        if(!b) el.addEventListener('click', ()=> openBookingModal(s.t))
        else el.addEventListener('click', ()=> openBookingModal(s.t, b))
        slotGrid.appendChild(el)
      }

      const rows = [...data.bookings].sort((a,b)=>a.start-b.start)
      for(const b of rows){
        const tr = document.createElement('tr')
        tr.innerHTML = `<td>${minToStr(b.start)}</td><td>${escapeHtml(b.client)}</td><td><span class="pill">${escapeHtml(b.proc)}</span></td><td>${b.dur} —Ö–≤</td><td>${escapeHtml(b.phone||'')}</td><td><button class="btn" data-edit="${b.start}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button></td>`
        dayTable.appendChild(tr)
      }

      Array.from(document.querySelectorAll('button[data-edit]')).forEach(btn=>{
        btn.addEventListener('click', ()=> {
          const start = +btn.getAttribute('data-edit')
          const b = byStart.get(start)
          openBookingModal(start, b)
        })
      })
    }

    function openBookingModal(startMin, existing){
      const d = datePicker.valueAsDate || new Date()
      const ymd = ymdFromDate(d)
      const data = loadDay(currentUser.id, ymd)

      editingBookingExisting = existing || null

      fStart.value = minToStr(startMin)
      fDur.value = existing ? existing.dur : slotLen.value
      fClient.value = existing ? existing.client : ''
      fPhone.value = existing ? existing.phone || '' : ''
      fProc.value = existing ? existing.proc : '–ú–∞–Ω—ñ–∫—é—Ä'
      fNote.value = existing ? existing.note || '' : ''
      btnDelete.style.display = existing ? 'inline-flex' : 'none'

      bookingModal.showModal()

      btnSave.onclick = (ev)=> {
        ev.preventDefault()
        const b = {
          start: startMin,
          dur: +fDur.value,
          client: fClient.value.trim(),
          phone: fPhone.value.trim(),
          proc: fProc.value,
          note: fNote.value.trim()
        }
        if(!b.client){ alert("–í–∫–∞–∂—ñ—Ç—å —ñ–º'—è –∫–ª—ñ—î–Ω—Ç–∞"); return }

        // overlap check
        for(const other of data.bookings){
          if(existing && other.start === existing.start) continue
          if(overlaps(b.start, b.dur, other.start, other.dur)){
            alert(`–ö–æ–Ω—Ñ–ª—ñ–∫—Ç –∑ ${minToStr(other.start)} (${other.client})`)
            return
          }
        }

        const idx = data.bookings.findIndex(x=> x.start === (existing?.start ?? b.start))
        if(idx >= 0) data.bookings[idx] = b
        else data.bookings.push(b)
        saveDay(currentUser.id, ymd, data)
        bookingModal.close()
        renderDay()
      }

      btnDelete.onclick = ()=> {
        if(!existing) return
        if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?')) return
        const i = data.bookings.findIndex(x=> x.start === existing.start)
        if(i>=0){ data.bookings.splice(i,1); saveDay(currentUser.id, ymd, data); bookingModal.close(); renderDay() }
      }

      btnCancel.onclick = ()=> bookingModal.close()
    }

    /* ---------------------------
       Admin: users management
       --------------------------- */
    function renderUsers(){
      userTable.innerHTML = ''
      for(const [id,u] of Object.entries(USERS)){
        const tr = document.createElement('tr')
        tr.innerHTML = `<td>${escapeHtml(id)}</td><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.role||'')}</td><td>
          <button class="btn" data-edit-user="${escapeHtml(id)}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
          <button class="btn" data-delete-user="${escapeHtml(id)}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </td>`
        userTable.appendChild(tr)
      }
      // attach handlers
      Array.from(userTable.querySelectorAll('[data-edit-user]')).forEach(btn=>{
        btn.addEventListener('click', ()=> openUserEdit(btn.getAttribute('data-edit-user')))
      })
      Array.from(userTable.querySelectorAll('[data-delete-user]')).forEach(btn=>{
        btn.addEventListener('click', ()=> {
          const id = btn.getAttribute('data-delete-user')
          if(id === 'admin' && !confirm('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ admin? –¶–µ –º–æ–∂–µ —É—Å–∫–ª–∞–¥–Ω–∏—Ç–∏ –¥–æ—Å—Ç—É–ø. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')===true) return
          if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${id}?`)) return
          delete USERS[id]
          saveUsers(USERS)
          renderUsers()
        })
      })
    }

    btnAddUser.addEventListener('click', ()=>{
      const id = (newLogin.value||'').trim()
      const pw = newPass.value||''
      const nm = newName.value || id
      const rl = newRole.value || 'Master'
      if(!id || !pw){ alert('–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å'); return }
      if(USERS[id]){ alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º –ª–æ–≥—ñ–Ω–æ–º –≤–∂–µ —ñ—Å–Ω—É—î'); return }
      USERS[id] = {password: pw, name: nm, role: rl}
      saveUsers(USERS)
      newLogin.value=newPass.value=newName.value=newRole.value=''
      renderUsers()
      alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ')
    })

    function openUserEdit(id){
      const u = USERS[id]
      if(!u) return
      uLogin.value = id
      uPass.value = ''
      uName.value = u.name
      uRole.value = u.role
      userModalTitle.textContent = `–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Äî ${id}`
      userModal.showModal()

      uSave.onclick = ()=> {
        const pw = uPass.value
        const nm = uName.value.trim() || id
        const rl = uRole.value.trim() || 'Master'
        if(pw) USERS[id].password = pw
        USERS[id].name = nm
        USERS[id].role = rl
        saveUsers(USERS)
        renderUsers()
        userModal.close()
      }

      uDelete.onclick = ()=> {
        if(id === 'admin' && !confirm('–í–∏–¥–∞–ª–∏—Ç–∏ admin? –¶–µ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –≤—Ç—Ä–∞—Ç–∏ –¥–æ—Å—Ç—É–ø—É. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) return
        if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${id}?`)) return
        delete USERS[id]
        saveUsers(USERS)
        renderUsers()
        userModal.close()
      }

      uCancel.onclick = ()=> userModal.close()
    }

    btnDumpAll.addEventListener('click', ()=>{
      const obj = {}
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i)
        obj[k] = localStorage.getItem(k)
      }
      dump.style.display = dump.style.display === 'none' ? 'block' : 'none'
      dump.textContent = JSON.stringify(obj, null, 2)
    })

    /* ---------------------------
       Utilities
       --------------------------- */
    function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]) }

    /* ---------------------------
       Initialize focus
       --------------------------- */
    setTimeout(()=> { try{ loginInput.focus() }catch(e){} },80)

    /* Expose load of USERS each time page loads */
    window.addEventListener('storage', (ev)=> {
      if(ev.key === LS_USERS_KEY) USERS = loadUsers()
    })
  })()
  </script>
</body>
</html>
